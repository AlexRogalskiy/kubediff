#!/usr/bin/env python

import yaml, sys, os, os.path, string, subprocess, optparse, json

failed = False

def check(b, kind, name, msg, *arg):
  global failed
  if not b:
    printer.diff(kind, name, msg, arg)
    failed = True

def diff_lists(path, kind, name, want, have):
  check(len(want) == len(have), kind, name, "len(%s): %d != %d", path, len(want), len(have))

  for i, (want_v, have_v) in enumerate(zip(want, have)):
     diff("%s[%d]" % (path, i), kind, name, want_v, have_v)

def diff_dicts(path, kind, name, want, have):
  for k, want_v in want.iteritems():
    key_path = "%s.%s" % (path, k)

    check(k in have, kind, name, "%s: '%s' missing", path, k)
    if k in have:
      diff(key_path, kind, name, want_v, have[k])

def diff(path, kind, name, want, have):
  if isinstance(want, dict):
    diff_dicts(path, kind, name, want, have)

  elif isinstance(want, list):
    diff_lists(path, kind, name, want, have)

  else:
    check(want == have, kind, name, "%s: '%s' != '%s'", path, want, have)

def check_file(path):
  _, extension = os.path.splitext(path)
  if extension != ".yaml":
    return

  with open(path, 'r') as stream:
    expected = yaml.load(stream)

  kind = expected["kind"]
  name = expected["metadata"]["name"]
  namespace = expected["metadata"]["namespace"] if "namespace" in expected["metadata"] else "default"

  printer.add(kind, name)

  args = ["--namespace=%s" % namespace, "-o=yaml"]
  if options.kubeconfig is not None:
    args.append("--kubeconfig=%s" % options.kubeconfig)

  try:
    running = subprocess.check_output(["kubectl", "get"] + args + [kind, name], stderr=subprocess.STDOUT)
  except subprocess.CalledProcessError, e:
    check(False, kind, name, " *** %s", e.output)
    return

  running = yaml.load(running)

  diff("", kind, name, expected, running)

def check_dir(path):
  for filename in os.listdir(path):
    check_path(os.path.join(path, filename))

def check_path(path):
  if os.path.isdir(path):
    check_dir(path)
  else:
    check_file(path)

class StdoutPrinter( object ):
  def add(self, kind, name):
    print "Checking %s '%s'" % (kind, name)

  def diff(self, kind, name, msg, arg):
    print " *** " + msg % arg

  def finish(self):
    return True

class JSONPrinter( object ):
  def __init__(self):
    self.data = {}

  def add(self, kind, name):
    self.data.setdefault(kind, {}).setdefault(name, [])

  def diff(self, kind, name, msg, arg):
    self.data[kind][name].append(arg)

  def finish(self):
    print json.dumps(self.data, sort_keys=True, indent=2, separators=(',', ': '))


if __name__ == "__main__":
  parser =  optparse.OptionParser("""usage: %prog [options] <dir/file>...

Compare yaml files in <dir> to running state in kubernetes and print the
differences.  This is useful to ensure you have applied all your changes to the
appropriate environement.  This tools runs kubectl, so unless your
~/.kube/config is configured for the correct environement, you will need to
supply the kubeconfig for the appropriate environment.""")
  parser.add_option("--kubeconfig", help="path to kubeconfig")
  parser.add_option("-j", "--json", help="output in json format", action="store_true", dest="json")
  (options, args) = parser.parse_args()
  if len(args) == 0:
    parser.print_help()
    sys.exit(1)

  printer = StdoutPrinter()
  if options.json:
    printer = JSONPrinter()

  for path in args:
    check_path(path)

  printer.finish()

  if failed:
    sys.exit(2)
